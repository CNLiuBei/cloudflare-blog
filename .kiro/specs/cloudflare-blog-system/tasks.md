# 实现计划: Cloudflare 全栈博客系统

## 概述

本计划将 Cloudflare 博客系统的设计分解为可执行的编码任务。采用后端优先的方式，先完成 API 和数据库，再实现前端界面。

## 任务

- [ ] 1. 项目初始化和基础配置
  - [x] 1.1 创建后端项目结构
    - 初始化 backend 目录，配置 TypeScript 和 Wrangler
    - 创建 wrangler.toml 配置文件，包含 D1 和 R2 绑定
    - 配置 package.json 和 tsconfig.json
    - _需求: 12.1, 12.2, 12.3_
  
  - [x] 1.2 创建前端项目结构
    - 使用 Vite 初始化 React + TypeScript 项目
    - 安装依赖：React Router、Axios、Ant Design、react-markdown
    - 配置 vite.config.ts 和 tsconfig.json
    - _需求: 前端要求_

  - [x] 1.3 创建数据库 Schema
    - 编写 schema.sql 文件，包含所有表定义
    - 包含 admins、categories、tags、articles、article_tags 表
    - 添加索引和外键约束
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [ ] 2. 后端核心模块实现
  - [x] 2.1 实现类型定义和工具函数
    - 创建 models/types.ts 定义所有数据类型
    - 创建 utils/response.ts 实现统一响应格式
    - 创建 utils/validation.ts 实现输入验证函数
    - _需求: 11.4, 11.5_

  - [ ]* 2.2 编写 API 响应格式属性测试
    - **属性 23: API 成功响应格式一致性**
    - **属性 24: API 错误响应格式一致性**
    - **验证: 需求 11.4, 11.5**

  - [x] 2.3 实现 JWT 认证模块
    - 创建 utils/jwt.ts 实现 JWT 签发和验证
    - 使用 jose 库处理 JWT 操作
    - 实现 24 小时有效期配置
    - _需求: 1.1, 1.5_

  - [ ]* 2.4 编写 JWT 认证属性测试
    - **属性 1: JWT 令牌往返一致性**
    - **属性 2: 无效凭据拒绝**
    - **验证: 需求 1.1, 1.2, 1.5**

  - [x] 2.5 实现认证中间件
    - 创建 middleware/auth.ts 实现 JWT 验证中间件
    - 处理有效/无效/过期 JWT 的情况
    - _需求: 1.3, 1.4, 11.6_

  - [ ]* 2.6 编写认证中间件属性测试
    - **属性 3: JWT 认证中间件正确性**
    - **验证: 需求 1.3, 1.4**

- [x] 3. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 4. 后端 API 处理器实现
  - [x] 4.1 实现登录 API
    - 创建 handlers/auth.ts 实现 POST /api/login
    - 验证用户名密码，返回 JWT 令牌
    - _需求: 1.1, 1.2, 11.2_

  - [x] 4.2 实现分类 CRUD API
    - 创建 handlers/categories.ts
    - 实现 GET /api/categories、POST/PUT/DELETE /api/admin/category
    - 实现删除保护（检查关联文章）
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 4.3 编写分类管理属性测试
    - **属性 9: 分类数据持久化往返**
    - **属性 10: 分类更新一致性**
    - **属性 11: 分类删除保护**
    - **验证: 需求 4.1, 4.2, 4.3, 4.4, 4.5**

  - [x] 4.4 实现标签 CRUD API
    - 创建 handlers/tags.ts
    - 实现 GET /api/tags、POST/DELETE /api/admin/tag
    - 实现级联删除 article_tags 关联
    - _需求: 5.1, 5.3, 5.4_

  - [ ]* 4.5 编写标签管理属性测试
    - **属性 12: 标签数据持久化往返**
    - **属性 14: 标签级联删除**
    - **验证: 需求 5.1, 5.3, 5.4**

  - [x] 4.6 实现文章 CRUD API
    - 创建 handlers/articles.ts
    - 实现 GET /api/articles（分页、筛选）、GET /api/article/:id
    - 实现 POST/PUT/DELETE /api/admin/article
    - 处理文章标签关联（article_tags）
    - _需求: 2.2, 2.4, 2.5, 2.6, 5.2, 5.5, 6.1, 6.3, 6.4, 6.5_

  - [ ]* 4.7 编写文章管理属性测试
    - **属性 4: 文章数据持久化往返**
    - **属性 5: 文章删除完整性**
    - **属性 6: 文章状态约束**
    - **属性 13: 文章标签关联完整性**
    - **属性 15: 公开 API 文章状态过滤**
    - **属性 16: 分页响应格式正确性**
    - **验证: 需求 2.2, 2.4, 2.5, 2.6, 5.2, 5.5, 6.1, 6.3, 6.4, 6.5**

  - [x] 4.8 实现文件上传 API
    - 创建 handlers/upload.ts 实现 POST /api/upload
    - 验证文件类型（仅图片）和大小（10MB 限制）
    - 生成唯一文件名，上传到 R2
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ]* 4.9 编写文件上传属性测试
    - **属性 7: 图片文件类型验证**
    - **属性 8: 文件名唯一性**
    - **验证: 需求 3.3, 3.5**

- [ ] 5. 后端路由整合
  - [x] 5.1 创建主路由入口
    - 创建 src/index.ts 整合所有路由
    - 配置 CORS 中间件
    - 应用 JWT 中间件到受保护路由
    - _需求: 11.1, 11.2, 11.3, 11.6_

  - [ ]* 5.2 编写筛选功能属性测试
    - **属性 19: 分类筛选正确性**
    - **属性 20: 标签筛选正确性**
    - **属性 18: 不存在文章返回 404**
    - **验证: 需求 7.4, 8.1, 8.2**

- [x] 6. 检查点 - 后端 API 完成
  - 确保所有后端测试通过，如有问题请询问用户。

- [ ] 7. 前端基础架构
  - [x] 7.1 创建 API 客户端封装
    - 创建 api/client.ts 封装 Axios 实例
    - 实现请求/响应拦截器
    - 处理 JWT 令牌自动附加和错误处理
    - _需求: 前端要求_

  - [x] 7.2 创建 API 模块
    - 创建 api/articles.ts、api/categories.ts、api/tags.ts、api/auth.ts
    - 封装所有 API 调用方法
    - _需求: 前端要求_

  - [x] 7.3 配置路由
    - 创建 App.tsx 配置 React Router
    - 定义公开路由和受保护路由
    - 实现路由守卫组件
    - _需求: 前端要求_

- [ ] 8. 前端公开页面实现
  - [x] 8.1 实现首页（文章列表）
    - 创建 pages/Home.tsx
    - 实现文章列表展示和分页
    - 实现分类和标签筛选
    - _需求: 6.1, 6.2, 6.3, 8.1, 8.2, 8.3_

  - [x] 8.2 实现文章详情页
    - 创建 pages/Article.tsx
    - 实现 Markdown 渲染（react-markdown）
    - 显示文章完整信息（标题、封面、内容、分类、标签）
    - _需求: 7.1, 7.2, 7.3, 7.4_

  - [ ]* 8.3 编写 Markdown 渲染属性测试
    - **属性 17: Markdown 渲染有效性**
    - **验证: 需求 7.2**

  - [x] 8.4 实现 SEO 组件
    - 创建 components/SEO.tsx 管理 meta 标签
    - 实现 title、description、keywords 设置
    - 实现 Open Graph 标签
    - _需求: 9.1, 9.3, 9.4_

  - [ ]* 8.5 编写 SEO 属性测试
    - **属性 21: SEO Meta 标签完整性**
    - **属性 22: Open Graph 标签完整性**
    - **验证: 需求 9.1, 9.4**

  - [x] 8.6 实现 404 页面
    - 创建 pages/NotFound.tsx
    - 处理不存在的路由和文章
    - _需求: 7.4_

- [ ] 9. 前端后台管理页面实现
  - [x] 9.1 实现登录页
    - 创建 pages/Login.tsx
    - 实现登录表单（Ant Design Form）
    - 处理登录成功/失败
    - _需求: 1.1, 1.2_

  - [x] 9.2 实现后台布局
    - 创建 components/AdminLayout.tsx
    - 实现侧边栏导航（文章、分类、标签管理）
    - 实现登出功能
    - _需求: 后台管理系统_

  - [x] 9.3 实现文章管理页
    - 创建 pages/Admin/Articles.tsx
    - 实现文章列表表格（Ant Design Table）
    - 实现新建、编辑、删除操作
    - _需求: 2.1, 2.3, 2.4_

  - [x] 9.4 实现文章编辑器
    - 创建 pages/Admin/ArticleEditor.tsx
    - 集成 Markdown 编辑器
    - 实现封面图片上传
    - 实现 SEO 字段编辑
    - 实现分类选择和标签多选
    - 实现草稿/发布状态切换
    - _需求: 2.1, 2.2, 2.3, 2.5, 2.6, 3.1, 3.2, 9.2_

  - [x] 9.5 实现分类管理页
    - 创建 pages/Admin/Categories.tsx
    - 实现分类列表、新建、编辑、删除
    - 处理删除保护提示
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [x] 9.6 实现标签管理页
    - 创建 pages/Admin/Tags.tsx
    - 实现标签列表、新建、删除
    - _需求: 5.1, 5.3_

- [x] 10. 检查点 - 前端功能完成
  - 确保所有前端功能正常工作，如有问题请询问用户。

- [ ] 11. 整合和部署配置
  - [x] 11.1 完善 wrangler.toml 配置
    - 确保 D1 数据库绑定正确
    - 确保 R2 存储桶绑定正确
    - 配置环境变量（JWT_SECRET）
    - _需求: 12.1, 12.2, 12.3_

  - [x] 11.2 创建部署文档
    - 在 README.md 中添加部署说明
    - 包含 D1 数据库初始化命令
    - 包含 R2 存储桶创建命令
    - 包含前端 Pages 部署说明
    - _需求: 12.4, 12.5_

- [x] 12. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。

## 备注

- 标记 `*` 的任务为可选任务，可跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点用于确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
